<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syslog Viewer</title>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" referrerpolicy="no-referrer" />
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-5 rounded-lg flex items-center space-x-3">
            <svg class="spinner w-8 h-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">Loading...</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Syslog Viewer</h1>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Router</label>
                <select id="routerSelect" class="w-full border border-gray-300 rounded-md p-2">
                    <option value="">Loading routers...</option>
                </select>
            </div>

            <!-- Server-side search section -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex gap-4">
                    <input type="text" id="serverSearch" placeholder="Search on server..." class="flex-1 border rounded-md px-3 py-2">
                    <button id="serverSearchBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">
                        Search
                    </button>
                    <button id="serverSearchResetBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                        Reset
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div class="flex space-x-4">
                    <select id="perPage" class="border rounded-md px-3 py-2">
                        <option value="5">5 per page</option>
                        <option value="10">10 per page</option>
                        <option value="25" selected>25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="1000">1000 per page</option>
                    </select>
                    <button id="exportAll" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Export All</button>
                    <button id="exportFiltered" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Export Filtered</button>
                </div>
                <div class="flex items-center gap-4">
                    <input type="text" id="search" placeholder="Search..." class="border rounded-md px-3 py-2 w-64">
                    <button id="toggleAdvanced" class="text-blue-600 hover:text-blue-800">
                        Advanced Search
                    </button>
                </div>
            </div>

            <!-- Advanced search section -->
            <div id="advancedSearch" class="mb-6 p-4 bg-gray-50 rounded-lg hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date/Time</label>
                        <input type="datetime-local" id="startDateTime" class="w-full border rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date/Time</label>
                        <input type="datetime-local" id="endDateTime" class="w-full border rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IP Address</label>
                        <input type="text" id="ipSearch" placeholder="Search IP..." class="w-full border rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">MAC Address</label>
                        <input type="text" id="macSearch" placeholder="Search MAC..." class="w-full border rounded-md px-3 py-2">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="applyAdvancedSearch" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Apply Filters
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="time">Time</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="user_id">User ID</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="protocol">Protocol</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="mac">MAC</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="local_ip">Local IP</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="remote_ip">Remote IP</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    Showing <span id="startRange">1</span> to <span id="endRange">5</span> of <span id="totalItems">0</span> entries
                </div>
                <div class="flex space-x-2">
                    <button id="prevPage" class="px-4 py-2 border rounded-md hover:bg-gray-50">Previous</button>
                    <div id="pagination" class="flex space-x-2"></div>
                    <button id="nextPage" class="px-4 py-2 border rounded-md hover:bg-gray-50">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let itemsPerPage = 25;
        let sortField = 'time';
        let sortDirection = 'desc';
        let allLogs = [];
        let filteredLogs = [];

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function resetServerSearch() {
            document.getElementById('serverSearch').value = '';
            document.getElementById('routerSelect').selectedIndex = 0;
            document.getElementById('search').value = '';
            document.getElementById('startDateTime').value = '';
            document.getElementById('endDateTime').value = '';
            document.getElementById('ipSearch').value = '';
            document.getElementById('macSearch').value = '';
            allLogs = [];
            filteredLogs = [];
            currentPage = 1;
            renderTable();
        }

        async function loadRouters() {
            try {
                showLoading();
                const response = await fetch('http://localhost:3000/routers');
                const routers = await response.json();
                
                const select = document.getElementById('routerSelect');
                select.innerHTML = '<option value="">Select a router</option>' + 
                    routers.map(router => `<option value="${router}">${router}</option>`).join('');
                
                select.addEventListener('change', loadRouterLogs);
            } catch (error) {
                console.error('Error loading routers:', error);
            } finally {
                hideLoading();
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            if (current) {
                result.push(current.trim());
            }
            
            return result;
        }

        function convertToCSV(data) {
            const headers = ['Time', 'User ID', 'Protocol', 'MAC', 'Local IP', 'Remote IP'];
            const rows = data.map(item => [
                new Date(item.time).toLocaleString(),
                item.user_id,
                item.protocol,
                item.mac,
                item.local_ip,
                item.remote_ip
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    const escaped = String(cell).replace(/"/g, '""');
                    return cell.includes(',') ? `"${escaped}"` : escaped;
                }).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(data, filename) {
            const csvContent = convertToCSV(data);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (navigator.msSaveBlob) {
                navigator.msSaveBlob(blob, filename);
            } else {
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        async function loadRouterLogs() {
            const routerId = document.getElementById('routerSelect').value;
            if (!routerId) return;

            try {
                showLoading();
                const response = await fetch(`http://localhost:3000/router/${routerId}`);
                const logs = await response.json();
                
                allLogs = logs.map(log => {
                    const parts = parseCSVLine(log.content);
                    return {
                        time: parts[0],
                        user_id: parts[1],
                        protocol: parts[2],
                        mac: parts[3],
                        local_ip: parts[4],
                        remote_ip: parts[5]
                    };
                });

                filteredLogs = [...allLogs];
                currentPage = 1;
                renderTable();
            } catch (error) {
                console.error('Error loading logs:', error);
            } finally {
                hideLoading();
            }
        }

        async function performServerSearch() {
            const routerId = document.getElementById('routerSelect').value;
            const searchTerm = document.getElementById('serverSearch').value;
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }

            const url = (!routerId) ? `http://localhost:3000/search?query=${searchTerm}` : `http://localhost:3000/router/${routerId}/search?query=${encodeURIComponent(searchTerm)}`;
            
            try {
                showLoading();
                const response = await fetch(url);
                const logs = await response.json();
                
                allLogs = logs.map(log => {
                    const parts = parseCSVLine(log.content);
                    return {
                        time: parts[0],
                        user_id: parts[1],
                        protocol: parts[2],
                        mac: parts[3],
                        local_ip: parts[4],
                        remote_ip: parts[5]
                    };
                });

                filteredLogs = [...allLogs];
                currentPage = 1;
                renderTable();
            } catch (error) {
                console.error('Error performing server search:', error);
            } finally {
                hideLoading();
            }
        }

        function applyAdvancedFilters() {
            const startDateTime = document.getElementById('startDateTime').value;
            const endDateTime = document.getElementById('endDateTime').value;
            const ipSearch = document.getElementById('ipSearch').value.toLowerCase();
            const macSearch = document.getElementById('macSearch').value.toLowerCase();

            filteredLogs = allLogs.filter(item => {
                const itemDate = new Date(item.time);
                
                if (startDateTime && itemDate < new Date(startDateTime)) return false;
                if (endDateTime && itemDate > new Date(endDateTime)) return false;
                
                if (ipSearch && 
                    !item.local_ip.toLowerCase().includes(ipSearch) && 
                    !item.remote_ip.toLowerCase().includes(ipSearch)) return false;
                
                if (macSearch && !item.mac.toLowerCase().includes(macSearch)) return false;
                
                return true;
            });

            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const sortedData = filteredLogs.sort((a, b) => {
                if (sortDirection === 'asc') {
                    return a[sortField] > b[sortField] ? 1 : -1;
                }
                return a[sortField] < b[sortField] ? 1 : -1;
            });
            
            const pageData = sortedData.slice(startIndex, endIndex);
            
            document.getElementById('tableBody').innerHTML = pageData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.time).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.user_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.protocol}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.mac}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.local_ip}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.remote_ip}</td>
                </tr>
            `).join('');

            updatePagination();
            updateRangeInfo();
        }

        function createPageButton(page, isActive = false) {
            return `<button class="px-4 py-2 ${isActive ? 'bg-blue-500 text-white' : 'border hover:bg-gray-50'} rounded-md" 
                    onclick="goToPage(${page})">${page}</button>`;
        }

        function createEllipsis() {
            return '<span class="px-4 py-2">...</span>';
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
            const paginationElement = document.getElementById('pagination');
            let paginationHTML = '';
            
            if (totalPages <= 5) {
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += createPageButton(i, i === currentPage);
                }
            } else {
                paginationHTML += createPageButton(1, currentPage === 1);
                
                if (currentPage > 3) {
                    paginationHTML += createEllipsis();
                }
                
                let start = Math.max(2, currentPage - 1);
                let end = Math.min(totalPages - 1, currentPage + 1);
                
                if (currentPage <= 3) {
                    end = 4;
                }
                if (currentPage >= totalPages - 2) {
                    start = totalPages - 3;
                }
                
                for (let i = start; i <= end; i++) {
                    paginationHTML += createPageButton(i, i === currentPage);
                }
                
                if (currentPage < totalPages - 2) {
                    paginationHTML += createEllipsis();
                }
                
                paginationHTML += createPageButton(totalPages, currentPage === totalPages);
            }
            
            paginationElement.innerHTML = paginationHTML;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            
            if (currentPage === 1) {
                document.getElementById('prevPage').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('prevPage').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (currentPage === totalPages) {
                document.getElementById('nextPage').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('nextPage').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateRangeInfo() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredLogs.length);
            const totalItems = filteredLogs.length;
            
            document.getElementById('startRange').textContent = startIndex;
            document.getElementById('endRange').textContent = endIndex;
            document.getElementById('totalItems').textContent = totalItems;
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        // Event Listeners
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        document.getElementById('perPage').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });

        document.getElementById('search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredLogs = allLogs.filter(item => 
                Object.values(item).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                )
            );
            currentPage = 1;
            renderTable();
        });

        document.getElementById('serverSearchBtn').addEventListener('click', performServerSearch);
        document.getElementById('serverSearchResetBtn').addEventListener('click', resetServerSearch);

        document.getElementById('toggleAdvanced').addEventListener('click', () => {
            const advancedSearch = document.getElementById('advancedSearch');
            advancedSearch.classList.toggle('hidden');
        });

        document.getElementById('applyAdvancedSearch').addEventListener('click', applyAdvancedFilters);

        document.getElementById('exportAll').addEventListener('click', () => {
            if (allLogs.length === 0) {
                alert('Please select a router first');
                return;
            }
            const routerId = document.getElementById('routerSelect').value;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadCSV(allLogs, `syslog-${routerId}-all-${timestamp}.csv`);
        });

        document.getElementById('exportFiltered').addEventListener('click', () => {
            if (filteredLogs.length === 0) {
                alert('No data to export');
                return;
            }
            const routerId = document.getElementById('routerSelect').value;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadCSV(filteredLogs, `syslog-${routerId}-filtered-${timestamp}.csv`);
        });

        document.querySelectorAll('.sort-header').forEach(header => {
            header.addEventListener('click', () => {
                const field = header.dataset.field;
                if (sortField === field) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDirection = 'asc';
                }
                renderTable();
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadRouters);
    </script>
</body>
</html>
