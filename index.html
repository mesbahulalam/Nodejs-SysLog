<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syslog Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Syslog Viewer</h1>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Router</label>
                <select id="routerSelect" class="w-full border border-gray-300 rounded-md p-2">
                    <option value="">Loading routers...</option>
                </select>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div class="flex space-x-4">
                    <select id="perPage" class="border rounded-md px-3 py-2">
                        <option value="5">5 per page</option>
                        <option value="10">10 per page</option>
                        <option value="25" selected>25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="1000">1000 per page</option>
                    </select>
                    <button id="exportAll" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Export All</button>
                    <button id="exportFiltered" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Export Filtered</button>
                </div>
                <input type="text" id="search" placeholder="Search..." class="border rounded-md px-3 py-2 w-64">
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="time">Time</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="user_id">User ID</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="protocol">Protocol</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="mac">MAC</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="local_ip">Local IP</th>
                            <th class="sort-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-field="remote_ip">Remote IP</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    Showing <span id="startRange">1</span> to <span id="endRange">5</span> of <span id="totalItems">0</span> entries
                </div>
                <div class="flex space-x-2">
                    <button id="prevPage" class="px-4 py-2 border rounded-md hover:bg-gray-50">Previous</button>
                    <div id="pagination" class="flex space-x-2"></div>
                    <button id="nextPage" class="px-4 py-2 border rounded-md hover:bg-gray-50">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let itemsPerPage = 25;
        let sortField = 'time';
        let sortDirection = 'desc';
        let allLogs = [];
        let filteredLogs = [];

        async function loadRouters() {
            try {
                const response = await fetch('http://localhost:3000/routers');
                const routers = await response.json();
                
                const select = document.getElementById('routerSelect');
                select.innerHTML = '<option value="">Select a router</option>' + 
                    routers.map(router => `<option value="${router}">${router}</option>`).join('');
                
                select.addEventListener('change', loadRouterLogs);
            } catch (error) {
                console.error('Error loading routers:', error);
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            if (current) {
                result.push(current.trim());
            }
            
            return result;
        }

        function convertToCSV(data) {
            const headers = ['Time', 'User ID', 'Protocol', 'MAC', 'Local IP', 'Remote IP'];
            const rows = data.map(item => [
                new Date(item.time).toLocaleString(),
                item.user_id,
                item.protocol,
                item.mac,
                item.local_ip,
                item.remote_ip
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma
                    const escaped = String(cell).replace(/"/g, '""');
                    return cell.includes(',') ? `"${escaped}"` : escaped;
                }).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(data, filename) {
            const csvContent = convertToCSV(data);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        async function loadRouterLogs() {
            const routerId = document.getElementById('routerSelect').value;
            if (!routerId) return;

            try {
                const response = await fetch(`http://localhost:3000/router/${routerId}`);
                const logs = await response.json();
                
                allLogs = logs.map(log => {
                    const parts = parseCSVLine(log.content);
                    return {
                        time: parts[0],
                        user_id: parts[1],
                        protocol: parts[2],
                        mac: parts[3],
                        local_ip: parts[4],
                        remote_ip: parts[5]
                    };
                });

                filteredLogs = [...allLogs];
                currentPage = 1;
                renderTable();
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function renderTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const sortedData = filteredLogs.sort((a, b) => {
                if (sortDirection === 'asc') {
                    return a[sortField] > b[sortField] ? 1 : -1;
                }
                return a[sortField] < b[sortField] ? 1 : -1;
            });
            
            const pageData = sortedData.slice(startIndex, endIndex);
            
            document.getElementById('tableBody').innerHTML = pageData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.time).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.user_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.protocol}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.mac}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.local_ip}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.remote_ip}</td>
                </tr>
            `).join('');

            updatePagination();
            updateRangeInfo();
        }

        function createPageButton(page, isActive = false) {
            return `<button class="px-4 py-2 ${isActive ? 'bg-blue-500 text-white' : 'border hover:bg-gray-50'} rounded-md" 
                    onclick="goToPage(${page})">${page}</button>`;
        }

        function createEllipsis() {
            return '<span class="px-4 py-2">...</span>';
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
            const paginationElement = document.getElementById('pagination');
            let paginationHTML = '';
            
            if (totalPages <= 5) {
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += createPageButton(i, i === currentPage);
                }
            } else {
                paginationHTML += createPageButton(1, currentPage === 1);
                
                if (currentPage > 3) {
                    paginationHTML += createEllipsis();
                }
                
                let start = Math.max(2, currentPage - 1);
                let end = Math.min(totalPages - 1, currentPage + 1);
                
                if (currentPage <= 3) {
                    end = 4;
                }
                if (currentPage >= totalPages - 2) {
                    start = totalPages - 3;
                }
                
                for (let i = start; i <= end; i++) {
                    paginationHTML += createPageButton(i, i === currentPage);
                }
                
                if (currentPage < totalPages - 2) {
                    paginationHTML += createEllipsis();
                }
                
                paginationHTML += createPageButton(totalPages, currentPage === totalPages);
            }
            
            paginationElement.innerHTML = paginationHTML;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            
            if (currentPage === 1) {
                document.getElementById('prevPage').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('prevPage').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (currentPage === totalPages) {
                document.getElementById('nextPage').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('nextPage').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateRangeInfo() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredLogs.length);
            const totalItems = filteredLogs.length;
            
            document.getElementById('startRange').textContent = startIndex;
            document.getElementById('endRange').textContent = endIndex;
            document.getElementById('totalItems').textContent = totalItems;
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        // Event Listeners
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        document.getElementById('perPage').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });

        document.getElementById('search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredLogs = allLogs.filter(item => 
                Object.values(item).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                )
            );
            currentPage = 1;
            renderTable();
        });

        document.getElementById('exportAll').addEventListener('click', () => {
            if (allLogs.length === 0) {
                alert('Please select a router first');
                return;
            }
            const routerId = document.getElementById('routerSelect').value;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadCSV(allLogs, `syslog-${routerId}-all-${timestamp}.csv`);
        });

        document.getElementById('exportFiltered').addEventListener('click', () => {
            if (filteredLogs.length === 0) {
                alert('No data to export');
                return;
            }
            const routerId = document.getElementById('routerSelect').value;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadCSV(filteredLogs, `syslog-${routerId}-filtered-${timestamp}.csv`);
        });

        document.querySelectorAll('.sort-header').forEach(header => {
            header.addEventListener('click', () => {
                const field = header.dataset.field;
                if (sortField === field) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDirection = 'asc';
                }
                renderTable();
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadRouters);
    </script>
</body>
</html>
